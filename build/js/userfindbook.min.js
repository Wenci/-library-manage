function postGetBook(a,b,c,d){var e=$("#drop>li.active").index(),f=["name","lib_id"];$.post("/userfindbook",{keyName:$("#search-key").val(),way:f[e],page:a,pageNum:b},function(e,f,g){0===e.book.length&&1===c&&(layer.close(index),layer.msg("没有更多的了")),addDataToHtml(e,a,c,b),d&&d(e,a,b),nowPageNum++})}function addDataToHtml(a,b,c,d){var e=a.book,f=$("<tbody></tbody>");0!=c&&(f=$("#results>tbody:first"));for(var g=0;g<e.length;g++)f.append(getTr(e[g],b*d+g+1));0===c&&$("#results>tbody").replaceWith(f),setTimeout(function(){layer.close(index)},1e3)}function getTr(a,b){var c=$("<tr></tr>"),d=[];d[0]=$("<td>"+b+"</td>"),d[1]=$("<td>"+a.name+"</td>"),d[2]=$("<td>"+a.author+"</td>"),d[3]=$("<td>"+a.lib_id+"</td>"),d[4]=$("<td>"+a.isbn+"</td>"),d[5]=$("<td>"+(a.num-a.borr_num)+"</td>"),d[6]=$("<td><a href='javascript:void(0)' class='btn btn-primary btn-xs'  data-id='"+a.id+"'>借阅</a></td>");for(var e=0;e<d.length;e++)c.append(d[e]);return c}function inputPassword(a){$("#confirm").css({display:"block"}),$("#confirm").attr("data-id",a)}$(function(){$("#drop>li").click(function(a){$("#drop>li").removeClass("active"),$(this).addClass("active"),$("#search-way>span:first").html($(this).text()+"&nbsp;")}),$("#search-key").bind("input propertychange",function(a){nowPageNum=0,postGetBook(0,20,0)}),$(window).scroll(function(a){$(document).height()-($(window).height()+$(document).scrollTop())<=0&&(index=layer.load(0,{shade:!1}),postGetBook(nowPageNum,20,1))}),$("#results").click(function(a){var b=a.target;"true"!=$(b).attr("data-disable")&&"a"===a.target.nodeName.toLowerCase()&&($(b).attr("data-disable","true"),$.post("/borrow",{bookId:a.target.getAttribute("data-id")},function(c,d,e){if($(b).attr("data-disable","false"),"success"==c){layer.msg("借阅成功");var f=$(b).parent().prev();f.text(parseInt(f.text())-1)}else"error"==c?layer.msg("借阅失败"):"notmore"==c?layer.msg("该书已经被借完"):"5"==c?layer.msg("你已经借阅了五本图书,不能借阅更多"):"login"==c&&inputPassword(a.target.getAttribute("data-id"))}))});var a=300,b=1200,c=700,d=$(".cd-top");$(window).scroll(function(){$(this).scrollTop()>a?d.addClass("cd-is-visible"):d.removeClass("cd-is-visible cd-fade-out"),$(this).scrollTop()>b&&d.addClass("cd-fade-out")}),d.on("click",function(a){a.preventDefault(),$("body,html").animate({scrollTop:0},c)}),$("#pass-form").submit(function(a){return $.post("/confirmpass",{password:$("#password").val()},function(a,b,c){"success"==a?($("#confirm").css({display:"none"}),$("a[data-id="+$("#confirm").attr("data-id")+"]").click()):layer.msg("密码错误")}),!1})});var index,nowPageNum=0;